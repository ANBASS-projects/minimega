# launch VMs to serve DHCP
vm config net LAN
vm config filesystem $minirouterfs
vm launch container router

router router interface 0 10.0.0.254/24
router router dhcp 10.0.0.254 range 10.0.0.1 10.0.0.5
router router dns 10.0.0.1 mm1
router router dns 10.0.0.2 mm2
router router dns 10.0.0.3 mm3
router router dns 10.0.0.4 mm4
router router dns 10.0.0.5 mm5
router router commit

# launch VMs to run minimega
clear vm config
vm config net LAN
vm config initrd $images/miniception.initrd
vm config kernel $images/miniception.kernel
vm config memory 4096
vm launch kvm 5

# start all VMs
vm start all

# send uminiccc image and untar
shell cp $images/uminicccfs.tar.gz /tmp/minimega/files
cc send uminicccfs.tar.gz
cc exec tar -C /root/ -xf /tmp/miniccc/files/uminicccfs.tar.gz
cc exec /usr/share/openvswitch/scripts/ovs-ctl start

# create a tap to talk to VM network
tap create LAN ip 10.0.0.100/24

# wait for VMs to launch and for minimega to start
shell sleep 90

# bridge into VM network
mesh dial 10.0.0.1

# wait for mesh to form
shell sleep 30
